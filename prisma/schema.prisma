// TesoritoOS - Restaurant Management System Schema
// Optimized for inventory tracking, real-time orders, and CRM

generator client {
    provider = "prisma-client-js"
}

datasource db {
    provider  = "postgresql"
    url       = env("DATABASE_URL")
    directUrl = env("DIRECT_URL")
}

// ============================================
// INVENTORY & RECIPES MODULE
// ============================================

model Ingredient {
    id           String   @id @default(cuid())
    name         String
    unit         String // "kg", "lt", "unit", "gr", "ml"
    currentStock Float    @map("current_stock")
    minimumStock Float    @default(0) @map("minimum_stock")
    costPerUnit  Float?   @map("cost_per_unit") // Optional: for cost analysis
    createdAt    DateTime @default(now()) @map("created_at")
    updatedAt    DateTime @updatedAt @map("updated_at")

    // Relations
    recipeItems      RecipeItem[]
    stockAdjustments StockAdjustment[]

    @@map("ingredients")
}

model MenuItem {
    id          String   @id @default(cuid())
    name        String
    description String?
    price       Float
    category    String? // "Entradas", "Platos Fuertes", "Bebidas", etc.
    imageUrl    String?  @map("image_url")
    isAvailable Boolean  @default(true) @map("is_available")
    createdAt   DateTime @default(now()) @map("created_at")
    updatedAt   DateTime @updatedAt @map("updated_at")

    // Relations
    recipeItems RecipeItem[]
    orderItems  OrderItem[]

    @@map("menu_items")
}

// Pivot table: Many-to-Many relationship between MenuItems and Ingredients
model RecipeItem {
    id               String @id @default(cuid())
    menuItemId       String @map("menu_item_id")
    ingredientId     String @map("ingredient_id")
    quantityRequired Float  @map("quantity_required") // Amount of ingredient needed for 1 serving

    // Relations
    menuItem   MenuItem   @relation(fields: [menuItemId], references: [id], onDelete: Cascade)
    ingredient Ingredient @relation(fields: [ingredientId], references: [id], onDelete: Cascade)

    @@unique([menuItemId, ingredientId])
    @@map("recipe_items")
}

// Stock adjustments history (for manual corrections or purchases)
model StockAdjustment {
    id           String   @id @default(cuid())
    ingredientId String   @map("ingredient_id")
    adjustment   Float // Can be positive (purchase) or negative (correction)
    reason       String? // "Compra", "Corrección de inventario", "Merma"
    userId       String?  @map("user_id") // Who made the adjustment
    createdAt    DateTime @default(now()) @map("created_at")

    ingredient Ingredient @relation(fields: [ingredientId], references: [id], onDelete: Cascade)

    @@map("stock_adjustments")
}

// ============================================
// ORDERS & POS MODULE
// ============================================

enum OrderStatus {
    PENDING // Order created, waiting to be prepared
    PREPARING // Chef is working on it
    READY // Ready for pickup/delivery
    DELIVERED // Order completed
    PAID // Payment processed
    CANCELLED // Order cancelled
}

model Order {
    id          String      @id @default(cuid())
    orderNumber String      @unique @map("order_number") // Human-readable (e.g., "001", "002")
    customerId  String?     @map("customer_id")
    source      String // "TikTok", "Instagram", "Pasaba por ahí", "Recomendación"
    status      OrderStatus @default(PENDING)
    table       String? // Table number or "Para llevar"
    notes       String? // Special instructions
    subtotal    Float       @default(0)
    tax         Float       @default(0)
    total       Float       @default(0)
    createdAt   DateTime    @default(now()) @map("created_at")
    updatedAt   DateTime    @updatedAt @map("updated_at")
    completedAt DateTime?   @map("completed_at")

    // Relations
    customer   Customer?   @relation(fields: [customerId], references: [id])
    orderItems OrderItem[]
    payment    Payment?

    @@map("orders")
}

model OrderItem {
    id         String   @id @default(cuid())
    orderId    String   @map("order_id")
    menuItemId String   @map("menu_item_id")
    quantity   Int      @default(1)
    unitPrice  Float    @map("unit_price") // Price at time of order
    notes      String? // Item-specific notes (e.g., "Sin cebolla")
    createdAt  DateTime @default(now()) @map("created_at")

    // Relations
    order    Order    @relation(fields: [orderId], references: [id], onDelete: Cascade)
    menuItem MenuItem @relation(fields: [menuItemId], references: [id])

    @@map("order_items")
}

// ============================================
// CRM & CUSTOMERS MODULE
// ============================================

model Customer {
    id            String    @id @default(cuid())
    name          String
    phone         String?   @unique
    email         String?   @unique
    birthday      DateTime? @db.Date
    loyaltyPoints Int       @default(0) @map("loyalty_points")
    totalSpend    Float     @default(0) @map("total_spend")
    createdAt     DateTime  @default(now()) @map("created_at")
    updatedAt     DateTime  @updatedAt @map("updated_at")

    // Relations
    orders Order[]

    @@map("customers")
}

// ============================================
// PAYMENTS MODULE
// ============================================

enum PaymentMethod {
    CASH
    CARD
    TRANSFER
    OTHER
}

model Payment {
    id             String        @id @default(cuid())
    orderId        String        @unique @map("order_id")
    method         PaymentMethod @default(CASH)
    amount         Float
    receivedAmount Float?        @map("received_amount") // For cash payments
    change         Float? // Cambio
    createdAt      DateTime      @default(now()) @map("created_at")

    // Relations
    order Order @relation(fields: [orderId], references: [id], onDelete: Cascade)

    @@map("payments")
}

// ============================================
// USERS & AUTH MODULE (Simplified)
// ============================================

enum UserRole {
    ADMIN
    MANAGER
    WAITER
    CHEF
}

model User {
    id        String   @id @default(cuid())
    email     String   @unique
    name      String
    role      UserRole @default(WAITER)
    password  String // In production, use proper hashing
    createdAt DateTime @default(now()) @map("created_at")
    updatedAt DateTime @updatedAt @map("updated_at")

    @@map("users")
}
